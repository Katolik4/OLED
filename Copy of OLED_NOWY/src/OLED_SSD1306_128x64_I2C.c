/*
 * OLED_SSD1306_128x64_I2C.c
 *
 *  Created on: 25 lis 2016
 *      Author: Piotr
 */
#include "stm32f10x.h"

#define I2C_SPEED                   50000                     /*!< I2C Speed */
#define I2C1_SSD1306_SLAVE_ADDRESS8 0x78                      // 8 bit slave address (write)
#define I2C_TIMEOUT                 100000

int OLED_COM (I2C_TypeDef *I2Cx, uint8_t slave_address, uint8_t slave_data) // wysylanie danych do oled po I2C
{
	// Sends I2C data over I2Cx:
	//  1) Sends Start Condition. Checks for I2C EV5
	//  2) Sends 7 bit address & checks for EV6
	//  3) Sends 8 bit command byte (0x00) & checks for EV8
	//  4) Sends 8 bits (1 byte) of data & checks for EV8
	//  5) Sends Stop Condition
	    int TimeOut;

	    #define COMMAND_BYTE 0x00

	    /* Send I2C1 START condition */
	    I2C_GenerateSTART(I2Cx, ENABLE);

	    /* Test on I2C1 EV5 and clear it */
	    TimeOut = I2C_TIMEOUT;
	    while(!I2C_CheckEvent(I2Cx, I2C_EVENT_MASTER_MODE_SELECT))
	    {
	        TimeOut--;
	        if (TimeOut == 0){
	            turn_on_error_led_pin();       // Error LED
	            return 0;
	        }
	    }

	    /* Send SSD1306 7 bit slave Address for write. Check to make sure ACK received */
	    I2C_Send7bitAddress(I2Cx, I2C1_SSD1306_SLAVE_ADDRESS8, I2C_Direction_Transmitter);

	    //Test on I2C1 EV6 and clear it
	    TimeOut = I2C_TIMEOUT;
	    while(!I2C_CheckEvent(I2Cx, I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED))
	    {
	        TimeOut--;
	        if (TimeOut == 0){
	            // Send I2C1 STOP Condition
	            I2C_GenerateSTOP(I2Cx, ENABLE);
	            turn_on_error_led_pin();        // Error LED

	            return 0;
	        }
	    }

	    I2C_SendData(I2Cx, COMMAND_BYTE);
	    while (!I2C_CheckEvent(I2Cx, I2C_EVENT_MASTER_BYTE_TRANSMITTED)){ // Wait for EV8
	        TimeOut--;
	        if (TimeOut == 0){
	            // Send I2C1 STOP Condition
	            I2C_GenerateSTOP(I2Cx, ENABLE);
	            turn_on_error_led_pin();        // Error LED

	            return 0;
	        }
	    }

	    I2C_SendData(I2Cx, slave_data);
				while (!I2C_CheckEvent(I2Cx, I2C_EVENT_MASTER_BYTE_TRANSMITTED)){ // Wait for EV8
					TimeOut--;
					if (TimeOut == 0){
						// Send I2C1 STOP Condition
						I2C_GenerateSTOP(I2Cx, ENABLE);
						turn_on_error_led_pin();        // Error LED

						return 0;
					}
				}

	    I2C_GenerateSTOP(I2Cx, ENABLE);
	    return 1;
}

void OLED_INIT (I2C_TypeDef *I2Cx, uint8_t slave_address)// inicjacja oled / ustawienia wstepne
{
	OLED_COM(I2Cx,slave_address,0xAE);   						// wylacz oled

	OLED_COM(I2Cx,slave_address,0x40);   					// linia #0

	OLED_COM(I2Cx,slave_address,0x20);   					// Memory Addressing Mode
	OLED_COM(I2Cx,slave_address,0x00);   					// 0-00 - Horizontal

	OLED_COM(I2Cx,slave_address,0x81);   					// Kontrast
	OLED_COM(I2Cx,slave_address,0xCF);   					//

	OLED_COM(I2Cx,slave_address,0xA1);   					// Segremap - 0xA1/0xA0
	OLED_COM(I2Cx,slave_address,0xC0);   					// COMSCAN DEC 0xC8 C0
	OLED_COM(I2Cx,slave_address,0xA6);   					// Wyswietlanie normalne 0xA6/0xA7 (odwrocone)

	OLED_COM(I2Cx,slave_address,0xA4);   					// DISPALY ALL ON REMUSE 0xA4
	OLED_COM(I2Cx,slave_address,0xA8);   					// Set Multipelx 0xA8
	OLED_COM(I2Cx,slave_address,0x3F);   						// 1/64 Duty Cycle

	OLED_COM(I2Cx,slave_address,0xD3);   					// Display Offset 0xD3
	OLED_COM(I2Cx,slave_address,0x00);   					// no offset

	OLED_COM(I2Cx,slave_address,0xD5);   					// Display Clk Div 0xD5
	OLED_COM(I2Cx,slave_address,0x80);   					// Recommended resistor ratio 0x80

	OLED_COM(I2Cx,slave_address,0xD9);   					// Set Precharge 0xD9
	OLED_COM(I2Cx,slave_address,0xF1);   					//

	OLED_COM(I2Cx,slave_address,0xDA);   					// Set COM Pins 0xDA
	OLED_COM(I2Cx,slave_address,0x12);   					//

	OLED_COM(I2Cx,slave_address,0xDB);   					// Set VCOM Detect 0xDB
	OLED_COM(I2Cx,slave_address,0x40);   					//

	OLED_COM(I2Cx,slave_address,0x8D);   					//Charge Pump 0x8D
	OLED_COM(I2Cx,slave_address,0x14);   					//

	OLED_COM(I2Cx,slave_address,0xA4);   					// Regular mode A4/ ON all pixels A5
	OLED_COM(I2Cx,slave_address,0xAF);   					// Turn on/off oled AF/AE

}

int OLED_DRAW_BUFF(I2C_TypeDef *I2Cx, uint8_t slave_address, uint8_t *buffer_pointer) //wysylanie calego buffera do oled
{
   #define SSD1306_COLUMNADDR  0x21
   #define SSD1306_PAGEADDR    0x22
   #define DATA_BYTE           0x40

   int TimeOut;

  OLED_COM(I2Cx, slave_address, SSD1306_COLUMNADDR);
  OLED_COM(I2Cx, slave_address, 0x00);            // Page Start address
  OLED_COM(I2Cx, slave_address, 0x7F);            // Page end address



  OLED_COM(I2Cx, slave_address, SSD1306_PAGEADDR);
  OLED_COM(I2Cx, slave_address, 0x00);            // Page Start address
  OLED_COM(I2Cx, slave_address, 0x07);            // Page end address

  OLED_COM(I2Cx,slave_address, 0x40);

   uint8_t x, y;


   /* Send I2C1 START condition */
   I2C_GenerateSTART(I2Cx, ENABLE);

   /* Test on I2C1 EV5 and clear it */
   TimeOut = I2C_TIMEOUT;
   while(!I2C_CheckEvent(I2Cx, I2C_EVENT_MASTER_MODE_SELECT))
   {
       TimeOut--;
       if (TimeOut == 0){
           turn_on_error_led_pin();       // Error LED
           return 1;
       }
   }

   /* Send SSD1306 7 bit slave Address for write. Check to make sure ACK received */
   I2C_Send7bitAddress(I2Cx, slave_address, I2C_Direction_Transmitter);

   //Test on I2C1 EV6 and clear it
   TimeOut = I2C_TIMEOUT;
   while(!I2C_CheckEvent(I2Cx, I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED))
   {
       TimeOut--;
       if (TimeOut == 0){
           // Send I2C1 STOP Condition
           I2C_GenerateSTOP(I2Cx, ENABLE);
           turn_on_error_led_pin();        // Error LED

           return 2;
       }
   }
   TimeOut = I2C_TIMEOUT;
   I2C_SendData(I2Cx, DATA_BYTE);
   while (!I2C_CheckEvent(I2Cx, I2C_EVENT_MASTER_BYTE_TRANSMITTED)){ // Wait for EV8
       TimeOut--;
       if (TimeOut == 0){
           // Send I2C1 STOP Condition
           I2C_GenerateSTOP(I2Cx, ENABLE);
           turn_on_error_led_pin();        // Error LED

           return 2;
       }
   }



   for(y=0; y<8; y++){
       for(x=0; x<128; x++){
           //I2C_SendData(I2Cx, const_global_display_buffer[(128*y)+x]);
           TimeOut = I2C_TIMEOUT;
       	I2C_SendData(I2Cx, buffer_pointer[(128*y)+x]);
           while (!I2C_CheckEvent(I2Cx, I2C_EVENT_MASTER_BYTE_TRANSMITTED)){ // Wait for EV8
               TimeOut--;
               if (TimeOut == 0){
                   // Send I2C1 STOP Condition
                   I2C_GenerateSTOP(I2Cx, ENABLE);
                   turn_on_error_led_pin();        // Error LED

                   return 2;
               }
           }
       }
   }
   I2C_GenerateSTOP(I2Cx, ENABLE);
   return 1;
}

int OLED_RAM(I2C_TypeDef *I2Cx, uint8_t slave_address, uint8_t *buffer_pointer, uint8_t COLUMN, uint8_t PAGE,uint8_t COLUMN_START, uint8_t PAGE_START) //wysylanie do RAM | LICZENIE OD 0
{
   #define SSD1306_COLUMNADDR  0x21
   #define SSD1306_PAGEADDR    0x22
   #define DATA_BYTE           0x40

   int TimeOut;
   uint8_t COLUMN_KONIEC = COLUMN_START+COLUMN;
   uint8_t PAGE_KONIEC = PAGE_START+PAGE;

   OLED_COM(I2Cx, slave_address, SSD1306_COLUMNADDR);
   OLED_COM(I2Cx, slave_address, COLUMN_START);            // Page Start address
   OLED_COM(I2Cx, slave_address, COLUMN_KONIEC);            // Page end address



   OLED_COM(I2Cx, slave_address, SSD1306_PAGEADDR);
   OLED_COM(I2Cx, slave_address, PAGE_START);            // Page Start address
   OLED_COM(I2Cx, slave_address, PAGE_KONIEC);            // Page end address
   uint8_t x, y;


   /* Send I2C1 START condition */
   I2C_GenerateSTART(I2Cx, ENABLE);

   /* Test on I2C1 EV5 and clear it */
   TimeOut = I2C_TIMEOUT;
   while(!I2C_CheckEvent(I2Cx, I2C_EVENT_MASTER_MODE_SELECT))
   {
       TimeOut--;
       if (TimeOut == 0){
           turn_on_error_led_pin();       // Error LED
           return 1;
       }
   }

   /* Send SSD1306 7 bit slave Address for write. Check to make sure ACK received */
   I2C_Send7bitAddress(I2Cx, slave_address, I2C_Direction_Transmitter);

   //Test on I2C1 EV6 and clear it
   TimeOut = I2C_TIMEOUT;
   while(!I2C_CheckEvent(I2Cx, I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED))
   {
       TimeOut--;
       if (TimeOut == 0){
           // Send I2C1 STOP Condition
           I2C_GenerateSTOP(I2Cx, ENABLE);
           turn_on_error_led_pin();        // Error LED

           return 2;
       }
   }
   TimeOut = I2C_TIMEOUT;
   I2C_SendData(I2Cx, DATA_BYTE);
   while (!I2C_CheckEvent(I2Cx, I2C_EVENT_MASTER_BYTE_TRANSMITTED)){ // Wait for EV8
       TimeOut--;
       if (TimeOut == 0){
           // Send I2C1 STOP Condition
           I2C_GenerateSTOP(I2Cx, ENABLE);
           turn_on_error_led_pin();        // Error LED

           return 2;
       }
   }

   for(y=0; y<PAGE+1; y++){
       for(x=0; x<COLUMN+1; x++){
           //I2C_SendData(I2Cx, const_global_display_buffer[(128*y)+x]);
           TimeOut = I2C_TIMEOUT;
       	I2C_SendData(I2Cx, buffer_pointer[((COLUMN+1)*y)+x]);
           while (!I2C_CheckEvent(I2Cx, I2C_EVENT_MASTER_BYTE_TRANSMITTED)){ // Wait for EV8
               TimeOut--;
               if (TimeOut == 0){
                   // Send I2C1 STOP Condition
                   I2C_GenerateSTOP(I2Cx, ENABLE);
                   turn_on_error_led_pin();        // Error LED

                   return 2;
               }
           }
       }
   }
   I2C_GenerateSTOP(I2Cx, ENABLE);
   return 1;

}

uint8_t BUFFER[1024]=//BUFFER poczatkowy
{
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x80,0xC0,0xF0,0xF0,0xF8,0x3C,0x3C,0x1C,0x1E,0x0E,0x0E,0x0E,
			0x0E,0x0E,0x0E,0x1E,0x1C,0x3C,0x3C,0x78,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x80,0xF0,0xFC,0xFC,0x3C,0xFC,0xFC,0xF0,0x80,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0xFC,0xFC,0xFC,0xFC,0x7C,0xFC,0xF8,0xC0,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFC,0xFC,0xFC,0xFC,0x00,0x00,0x00,0x00,0x00,
			0x00,0xFC,0xFC,0xFC,0xFC,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,0x1C,
			0x1C,0x1C,0x1C,0x1C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xF0,0xFC,
			0xFC,0x3C,0xFC,0xFC,0xF0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0xF0,0xFE,0xFF,0xFF,0x0F,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0xE0,0xFC,0xFF,0xFF,0x1F,0x01,0x00,0x03,0x1F,0xFF,0xFF,0xFC,0xE0,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x01,0x07,0x1F,0xFF,0xFC,
			0xF0,0xC0,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,
			0x00,0xFF,0xFF,0xFF,0xFF,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,
			0xC0,0xC0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE0,0xFC,0xFF,0xFF,0x1F,
			0x01,0x00,0x03,0x1F,0xFF,0xFF,0xFC,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x3F,0xFF,0xFF,0xFF,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xF8,0xFF,
			0xFF,0x7F,0x77,0x70,0x70,0x70,0x70,0x70,0x70,0x70,0x77,0x7F,0xFF,0xFF,0xF8,0xC0,
			0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x03,
			0x0F,0x3F,0xFF,0xFC,0xF0,0x80,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,
			0x00,0xFF,0xFF,0xFF,0xFF,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
			0x01,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0xC0,0xF8,0xFF,0xFF,0x7F,0x77,0x70,0x70,
			0x70,0x70,0x70,0x70,0x70,0x77,0x7F,0xFF,0xFF,0xF8,0xC0,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x01,0x07,0x1F,0x3F,0x7E,0x7C,0xF0,0xF0,0xE0,0xE0,0xC0,0xC0,0xC0,
			0xC0,0xC0,0xC0,0xE0,0xE0,0xF0,0xF0,0x78,0x7C,0x00,0x80,0xF0,0xFE,0xFF,0x7F,0x0F,
			0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x0F,0x7F,0xFF,
			0xFE,0xF0,0x80,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x03,0x0F,0x3F,0xFE,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,
			0x00,0xFF,0xFF,0xFF,0xFF,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,
			0xE0,0xE0,0xE0,0xE0,0x00,0x80,0xF0,0xFE,0xFF,0x7F,0x0F,0x01,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x0F,0x7F,0xFF,0xFE,0xF0,0x80,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,
			0x01,0x01,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
			0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
}
